<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>安全性、权限验证、角色成员分配</title>
    <meta name="generator" content="VuePress 1.7.0">
    <link rel="apple-touch-icon" href="/docs/apple-touch-icon.png">
    <link rel="icon" href="/docs/favicon.ico">
    <link rel="manifest" href="/docs/manifest.json">
    <meta name="description" content="学到的 用到的 感兴趣的">
    <meta name="theme-color" content="#ffffff">
    
    <link rel="preload" href="/docs/assets/css/0.styles.f7b3d1c5.css" as="style"><link rel="preload" href="/docs/assets/js/app.ebbf42bd.js" as="script"><link rel="preload" href="/docs/assets/js/2.e91ea41e.js" as="script"><link rel="preload" href="/docs/assets/js/19.afb702b1.js" as="script"><link rel="preload" href="/docs/assets/js/3.f31d052a.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.b4b51801.js"><link rel="prefetch" href="/docs/assets/js/11.a431a81f.js"><link rel="prefetch" href="/docs/assets/js/12.1f6b7235.js"><link rel="prefetch" href="/docs/assets/js/13.d9ff6aa4.js"><link rel="prefetch" href="/docs/assets/js/14.f7885770.js"><link rel="prefetch" href="/docs/assets/js/15.17c99732.js"><link rel="prefetch" href="/docs/assets/js/16.71c687bf.js"><link rel="prefetch" href="/docs/assets/js/17.8ad4810f.js"><link rel="prefetch" href="/docs/assets/js/18.fd691143.js"><link rel="prefetch" href="/docs/assets/js/20.a4e19a04.js"><link rel="prefetch" href="/docs/assets/js/21.8b804b37.js"><link rel="prefetch" href="/docs/assets/js/22.b82986ab.js"><link rel="prefetch" href="/docs/assets/js/23.7917dd64.js"><link rel="prefetch" href="/docs/assets/js/24.2b2e5ffb.js"><link rel="prefetch" href="/docs/assets/js/25.48503e12.js"><link rel="prefetch" href="/docs/assets/js/26.efa1f7d6.js"><link rel="prefetch" href="/docs/assets/js/27.b7c67ff6.js"><link rel="prefetch" href="/docs/assets/js/28.43e104a6.js"><link rel="prefetch" href="/docs/assets/js/29.4d280c4e.js"><link rel="prefetch" href="/docs/assets/js/30.b22c2f67.js"><link rel="prefetch" href="/docs/assets/js/31.ad804432.js"><link rel="prefetch" href="/docs/assets/js/32.1099049b.js"><link rel="prefetch" href="/docs/assets/js/33.3dd5e29c.js"><link rel="prefetch" href="/docs/assets/js/34.98d646da.js"><link rel="prefetch" href="/docs/assets/js/35.8f1d466f.js"><link rel="prefetch" href="/docs/assets/js/36.bbed7c7a.js"><link rel="prefetch" href="/docs/assets/js/37.777ee62c.js"><link rel="prefetch" href="/docs/assets/js/38.934e506a.js"><link rel="prefetch" href="/docs/assets/js/39.2e252bff.js"><link rel="prefetch" href="/docs/assets/js/4.e3a22a46.js"><link rel="prefetch" href="/docs/assets/js/40.659d935c.js"><link rel="prefetch" href="/docs/assets/js/41.f2c2f7ee.js"><link rel="prefetch" href="/docs/assets/js/42.619321e9.js"><link rel="prefetch" href="/docs/assets/js/43.42d4eb10.js"><link rel="prefetch" href="/docs/assets/js/44.cb7ff5d2.js"><link rel="prefetch" href="/docs/assets/js/45.6e09cc4a.js"><link rel="prefetch" href="/docs/assets/js/46.dea94a79.js"><link rel="prefetch" href="/docs/assets/js/47.57b2831e.js"><link rel="prefetch" href="/docs/assets/js/48.8e723307.js"><link rel="prefetch" href="/docs/assets/js/49.e5c8403c.js"><link rel="prefetch" href="/docs/assets/js/5.1f4073b2.js"><link rel="prefetch" href="/docs/assets/js/50.d6e3c8e4.js"><link rel="prefetch" href="/docs/assets/js/51.c3667e29.js"><link rel="prefetch" href="/docs/assets/js/52.bb18881d.js"><link rel="prefetch" href="/docs/assets/js/53.be51bb0b.js"><link rel="prefetch" href="/docs/assets/js/54.840b7a76.js"><link rel="prefetch" href="/docs/assets/js/55.2fa45451.js"><link rel="prefetch" href="/docs/assets/js/56.5494f328.js"><link rel="prefetch" href="/docs/assets/js/57.38d0acdd.js"><link rel="prefetch" href="/docs/assets/js/58.6ebf3d7a.js"><link rel="prefetch" href="/docs/assets/js/59.d3d76087.js"><link rel="prefetch" href="/docs/assets/js/6.fbc0230d.js"><link rel="prefetch" href="/docs/assets/js/60.967b85b2.js"><link rel="prefetch" href="/docs/assets/js/61.43942bea.js"><link rel="prefetch" href="/docs/assets/js/62.2448d643.js"><link rel="prefetch" href="/docs/assets/js/63.2a2d7f97.js"><link rel="prefetch" href="/docs/assets/js/64.42a5680c.js"><link rel="prefetch" href="/docs/assets/js/65.12f7634e.js"><link rel="prefetch" href="/docs/assets/js/66.83f182f5.js"><link rel="prefetch" href="/docs/assets/js/67.791074e3.js"><link rel="prefetch" href="/docs/assets/js/68.f57897f8.js"><link rel="prefetch" href="/docs/assets/js/7.170c203a.js"><link rel="prefetch" href="/docs/assets/js/8.280ea156.js"><link rel="prefetch" href="/docs/assets/js/9.85c7d6b8.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.f7b3d1c5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><img src="/docs/favicon.ico" alt="" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/backend/dot-net-mvc5/" class="nav-link router-link-active">
  .NET MVC5
</a></li><li class="dropdown-item"><!----> <a href="/docs/backend/gRPC/" class="nav-link">
  Grpc
</a></li><li class="dropdown-item"><!----> <a href="/docs/backend/container/" class="nav-link">
  容器
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/frontend/javascript/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/docs/frontend/echarts/" class="nav-link">
  Echarts
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/more/books/" class="nav-link">
  看过的书
</a></li><li class="dropdown-item"><!----> <a href="/docs/more/toos/" class="nav-link">
  折腾
</a></li><li class="dropdown-item"><!----> <a href="/docs/more/ubuntu/" class="nav-link">
  Ubuntu
</a></li><li class="dropdown-item"><!----> <a href="/docs/more/git/" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/docs/more/leetcode/" class="nav-link">
  LeetCode
</a></li></ul></div></div> <a href="https://github.com/WuHaaaaa/WuHaaaaa.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/backend/dot-net-mvc5/" class="nav-link router-link-active">
  .NET MVC5
</a></li><li class="dropdown-item"><!----> <a href="/docs/backend/gRPC/" class="nav-link">
  Grpc
</a></li><li class="dropdown-item"><!----> <a href="/docs/backend/container/" class="nav-link">
  容器
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/frontend/javascript/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/docs/frontend/echarts/" class="nav-link">
  Echarts
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/more/books/" class="nav-link">
  看过的书
</a></li><li class="dropdown-item"><!----> <a href="/docs/more/toos/" class="nav-link">
  折腾
</a></li><li class="dropdown-item"><!----> <a href="/docs/more/ubuntu/" class="nav-link">
  Ubuntu
</a></li><li class="dropdown-item"><!----> <a href="/docs/more/git/" class="nav-link">
  Git
</a></li><li class="dropdown-item"><!----> <a href="/docs/more/leetcode/" class="nav-link">
  LeetCode
</a></li></ul></div></div> <a href="https://github.com/WuHaaaaa/WuHaaaaa.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>.NET MVC 5</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/backend/dot-net-mvc5/" aria-current="page" class="sidebar-link">首页</a></li><li><a href="/docs/backend/dot-net-mvc5/01asp-dot-net-mvc5.html" class="sidebar-link">控制器、试图、模型</a></li><li><a href="/docs/backend/dot-net-mvc5/02asp-dot-net-mvc5.html" class="sidebar-link">表单和HTML辅助方法</a></li><li><a href="/docs/backend/dot-net-mvc5/03asp-dot-net-mvc5.html" class="sidebar-link">数据注解，验证</a></li><li><a href="/docs/backend/dot-net-mvc5/04asp-dot-net-mvc5.html" aria-current="page" class="active sidebar-link">安全性、权限验证、角色成员分配</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/backend/dot-net-mvc5/04asp-dot-net-mvc5.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/docs/backend/dot-net-mvc5/04asp-dot-net-mvc5.html#本章总结" class="sidebar-link">本章总结</a></li><li class="sidebar-sub-header"><a href="/docs/backend/dot-net-mvc5/04asp-dot-net-mvc5.html#authorize" class="sidebar-link">Authorize</a></li><li class="sidebar-sub-header"><a href="/docs/backend/dot-net-mvc5/04asp-dot-net-mvc5.html#注册全局过滤器" class="sidebar-link">注册全局过滤器</a></li><li class="sidebar-sub-header"><a href="/docs/backend/dot-net-mvc5/04asp-dot-net-mvc5.html#阻止xss-跨脚本攻击" class="sidebar-link">阻止XSS（跨脚本攻击）</a></li><li class="sidebar-sub-header"><a href="/docs/backend/dot-net-mvc5/04asp-dot-net-mvc5.html#威胁-跨站请求伪造-csrf-xsrf" class="sidebar-link">威胁：跨站请求伪造（CSRF，XSRF）</a></li><li class="sidebar-sub-header"><a href="/docs/backend/dot-net-mvc5/04asp-dot-net-mvc5.html#威胁-cookie盗窃" class="sidebar-link">威胁：cookie盗窃</a></li><li class="sidebar-sub-header"><a href="/docs/backend/dot-net-mvc5/04asp-dot-net-mvc5.html#威胁-过多提交-over-posting" class="sidebar-link">威胁：过多提交（Over-Posting）</a></li><li class="sidebar-sub-header"><a href="/docs/backend/dot-net-mvc5/04asp-dot-net-mvc5.html#威胁-开放重定向攻击" class="sidebar-link">威胁：开放重定向攻击</a></li><li class="sidebar-sub-header"><a href="/docs/backend/dot-net-mvc5/04asp-dot-net-mvc5.html#使用错误日志、堆栈跟踪程序出错信息" class="sidebar-link">使用错误日志、堆栈跟踪程序出错信息</a></li></ul></li><li><a href="/docs/backend/dot-net-mvc5/05asp-dot-net-mvc5.html" class="sidebar-link">Ajax，jQuery插件用法</a></li><li><a href="/docs/backend/dot-net-mvc5/06asp-dot-net-mvc5.html" class="sidebar-link">路由概念，底层实现</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <blockquote><p>这一章，对应的是书上的第七章，主要讲述安全性、权限验证、角色成员分配等，这些也是常用<code>web</code>系统所需要的，需要好好看看</p></blockquote> <h2 id="本章总结"><a href="#本章总结" class="header-anchor">#</a> 本章总结</h2> <p>这是本书作者在本章开头写下的，我认为这些很有用，记录一下</p> <blockquote><p><strong>永远都不要相信用户提供的任何数据</strong></p> <p>下面是一些实际的例子：</p> <ul><li>每当渲染作为用户输入而引入的数据时，请对其进行编码，最常见的做法是使用<code>HTML</code>编码。但是，如果数据作为特性值显示，就应对其进行<code>HTML</code>特性编码；如果数据用在<code>JavaScript</code>代码段中，就应该对其进行<code>JavaScript</code>编码。有些时候，需要进行多层编码，如<code>HTML</code>页面中的<code>JavaScript</code>代码段</li> <li>考虑好网站的哪些部分允许匿名访问，哪些部分要求认证访问</li> <li>不要试图自己净化用户的<code>HTML</code>输入（使用正则表达式或其他方法）——否则就会失败。</li> <li>在不需要通过客户端脚本（大部分情况下）访问<code>cookie</code>时，使用<code>Http-only cookie</code>。</li> <li>请记住，外部输入不只是显示的表单域，还包括<code>URL</code>查询字符串、隐藏表单域、<code>Ajax</code>请求以及我们使用的外部<code>Web</code>服务结果等。</li> <li>建议使用<code>AntiXSS</code>编码器（这是<code>Microsoft Web Protection Library</code>的一个组件，<code>ASP.NET 4.5</code>及更高的版本自带该库。</li></ul></blockquote> <h2 id="authorize"><a href="#authorize" class="header-anchor">#</a> Authorize</h2> <p>通过这个特性，我们可以设置有关权限验证的页面，只有当用户登陆后，才能访问</p> <div class="language-CSharp extra-class"><pre class="language-csharp"><code><span class="token comment">//比如一个购买页面，我们需要验证身份</span>
<span class="token punctuation">[</span>Authorize<span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name">ActionResult</span> <span class="token function">Buy</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> album <span class="token operator">=</span> <span class="token function">GetAlbums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Single</span><span class="token punctuation">(</span>a <span class="token operator">=&gt;</span> a<span class="token punctuation">.</span>AlbumId <span class="token operator">==</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//Charge the user and ship the album!!!</span>
    <span class="token keyword">return</span> <span class="token function">View</span><span class="token punctuation">(</span>album<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当我们点击Buy时，它会验证当前用户是否已登录，然后判断，若未登录，则会重定向到登录页，若已登录，则继续进行下面的操作。</p> <h2 id="注册全局过滤器"><a href="#注册全局过滤器" class="header-anchor">#</a> 注册全局过滤器</h2> <p>一般情况下，我们开发的网站，大多地方需要登陆后浏览，所以我们为了节省我们的开发，也为了方便（若按照上面<code>Authorize</code>特性的方式，每个方法都要添加<code>Authorize</code>，不得累死），我们就需要注册全局的权限验证过滤器，然后通过<code>AllowAnonymous</code>特性，允许一部分的控制器，可以在不登录时访问</p> <p>注册全局过滤器，<code>FilterConfig.cs</code></p> <div class="language-CSharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">RegisterGlobalFilters</span><span class="token punctuation">(</span><span class="token class-name">GlobalFilterCollection</span> filters<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    filters<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">HandleErrorAttribute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//新注册的全局过滤器</span>
    filters<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">System<span class="token punctuation">.</span>Web<span class="token punctuation">.</span>Mvc<span class="token punctuation">.</span>AuthorizeAttribute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>允许一部分控制器不登录，即可访问，<code>AccountController.cs</code></p> <div class="language-CSharp extra-class"><pre class="language-csharp"><code><span class="token comment">// GET: /Account/Login</span>
<span class="token punctuation">[</span>AllowAnonymous<span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name">ActionResult</span> <span class="token function">Login</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> returnUrl<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    ViewBag<span class="token punctuation">.</span>ReturnUrl <span class="token operator">=</span> returnUrl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">View</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//</span>
<span class="token comment">// POST: /Account/Login</span>
<span class="token punctuation">[</span>HttpPost<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">AllowAnonymous</span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ValidateAntiForgeryToken</span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>ActionResult<span class="token punctuation">&gt;</span></span> <span class="token function">Login</span><span class="token punctuation">(</span><span class="token class-name">LoginViewModel</span> model<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> returnUrl<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ModelState<span class="token punctuation">.</span>IsValid<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">View</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token range operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="阻止xss-跨脚本攻击"><a href="#阻止xss-跨脚本攻击" class="header-anchor">#</a> 阻止XSS（跨脚本攻击）</h2> <h3 id="跨站脚本攻击分类"><a href="#跨站脚本攻击分类" class="header-anchor">#</a> 跨站脚本攻击分类</h3> <p><a href="https://blog.csdn.net/qq_36119192/article/details/82469035" target="_blank" rel="noopener noreferrer">图片参考：XSS(跨站脚本攻击)详解<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="被动注入"><a href="#被动注入" class="header-anchor">#</a> 被动注入</h4> <p>例如：用户评论时，加了一个<code>JavaScript</code>脚本，但是评论系统提交的时候，没有验证出来，导致其他用户访问当前页面时，该页面就会执行脚本</p> <p><img src="https://i.imgur.com/ipQayvg.png" alt="img"></p> <h4 id="主动注入"><a href="#主动注入" class="header-anchor">#</a> 主动注入</h4> <p>黑客会在例如博客系统评论中添加恶意链接，用户点击后，跳到与该网站类似的网站，诱导用户输入关键信息</p> <p><img src="https://i.imgur.com/OQ0wMw2.png" alt="img"></p> <h3 id="第一种-对所有内容进行html编码"><a href="#第一种-对所有内容进行html编码" class="header-anchor">#</a> 第一种：对所有内容进行HTML编码</h3> <p><code>Html.Encode()</code>：它会对页面内容进行编码，例如用户输入密码，用户名，将所有待编码字符编码</p> <p><code>Html.AttributeEncode()</code>：编码个别的几个字符<code>''</code>、<code>&amp;</code>、<code>~</code>、<code>\</code></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!--Create--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>Create<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
Create
<span class="token comment">&lt;!--Encode--&gt;</span>
@Html.Encode(&quot;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>qw3<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span> Create<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>&quot;)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span> <span class="token punctuation">/&gt;</span></span>
<span class="token entity named-entity" title="&lt;">&amp;lt;</span>h2 class=<span class="token entity" title="'">&amp;#39;</span>qw3<span class="token entity" title="'">&amp;#39;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span> Create<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/h2<span class="token entity named-entity" title="&gt;">&amp;gt;</span>
<span class="token comment">&lt;!--AttributeEncode:--&gt;</span>
@Html.AttributeEncode(&quot;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>qw3<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span> Create<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>&quot;)
<span class="token entity named-entity" title="&lt;">&amp;lt;</span>h2 class=<span class="token entity" title="'">&amp;#39;</span>qw3<span class="token entity" title="'">&amp;#39;</span>&gt; Create<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/h2&gt;
</code></pre></div><h3 id="第二种-对javascript进行编码"><a href="#第二种-对javascript进行编码" class="header-anchor">#</a> 第二种：对<code>JavaScript</code>进行编码</h3> <p><code>Ajax.JavaScriptStringEncode</code>：对使用字符串进行编码</p> <div class="language-html extra-class"><pre class="language-html"><code>@Ajax.JavaScriptStringEncode(&quot;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">Hello<span class="token punctuation">,</span>world</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>&quot;)
\u003cscript\u003eHello,world\u003c/script\u003e
</code></pre></div><h3 id="第三种-使用anitxss编码"><a href="#第三种-使用anitxss编码" class="header-anchor">#</a> 第三种，使用<code>AnitXSS</code>编码</h3> <p><code>AnitXSS</code>编码，需要自己搜一下例子，大致也是对HTML进行编码，不过更加完善，而且有白名单、黑名单，针对关键字过滤</p> <h2 id="威胁-跨站请求伪造-csrf-xsrf"><a href="#威胁-跨站请求伪造-csrf-xsrf" class="header-anchor">#</a> 威胁：跨站请求伪造（CSRF，XSRF）</h2> <h3 id="混淆代理"><a href="#混淆代理" class="header-anchor">#</a> 混淆代理</h3> <div class="language-CSharp extra-class"><pre class="language-csharp"><code><span class="token comment">//当没有添加这两个属性，当程序中出现其他请求，将不会很好的验证</span>
<span class="token comment">//[HttpPost]</span>
<span class="token comment">//[ValidateAntiForgeryToken]</span>
<span class="token keyword">public</span> <span class="token return-type class-name">ActionResult</span> <span class="token function">Logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	AuthenticationManager<span class="token punctuation">.</span><span class="token function">SignOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">RedirectToAction</span><span class="token punctuation">(</span><span class="token string">&quot;Index&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Home&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果这时候，有用户在当前系统中发表了一个评论（假设这是一个博客系统），那么这时，用户输入下面的示例：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>/account/logout<span class="token punctuation">'</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre></div><p>当其他用户访问这个页面的时候，会触发程序请求<code>图片</code>，发出请求后，会导致程序退出（这就是所谓的混淆代理）</p> <h3 id="阻止csrf攻击"><a href="#阻止csrf攻击" class="header-anchor">#</a> 阻止CSRF攻击</h3> <h4 id="第一种-令牌验证"><a href="#第一种-令牌验证" class="header-anchor">#</a> 第一种：令牌验证</h4> <p>.NET MVC可以通过令牌验证，阻止CSRF攻击</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/xxx/xxx<span class="token punctuation">&quot;</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    @Html.AntiForgeryToken()
...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>当渲染倒界面上，就会出现一个隐藏的<code>input</code>标签，用于提交表单时进行验证</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/xxx/xxx<span class="token punctuation">&quot;</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>post<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hidden<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>46sfdgf5ds4g6dsfg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>后端也有相应的验证</p> <div class="language-CSharp extra-class"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ValidateAntiforgeryToken</span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name">ActionResult</span> <span class="token function">Register</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">{</span> 
    <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="第二种-httpreferrer验证"><a href="#第二种-httpreferrer验证" class="header-anchor">#</a> 第二种：HttpReferrer验证</h4> <p>通过refer防盗链来解决非当前站点提交</p> <div class="language-CSharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IsPostedFormThisSiteAttribute</span><span class="token punctuation">:</span><span class="token type-list"><span class="token class-name">AuthorizeAttribute</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnAuthorize</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationContext</span> filterContext<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>filterContext<span class="token punctuation">.</span>HttpContext <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>filterContext<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>UrlReferrer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">System<span class="token punctuation">.</span>Web<span class="token punctuation">.</span>HttpException</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid submission&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>filterContext<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>UrlReferrer<span class="token punctuation">.</span>Host <span class="token operator">!=</span> <span class="token string">&quot;mysite.com&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">System<span class="token punctuation">.</span>Web<span class="token punctuation">.</span>HttpException</span><span class="token punctuation">(</span><span class="token string">&quot;This form wasn't submitted from this site!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>        
    <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>
</code></pre></div><p>运用</p> <div class="language-CSharp extra-class"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">IsPostedFormThisSiteAttribute</span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name">ActionResult</span> <span class="token function">Register</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="威胁-cookie盗窃"><a href="#威胁-cookie盗窃" class="header-anchor">#</a> 威胁：cookie盗窃</h2> <p>当黑客盗取了我们的cookie，他们便能通过cookie，登录我们登录过的网站，在里面搞破坏</p> <h3 id="禁止cookie盗窃-httponly"><a href="#禁止cookie盗窃-httponly" class="header-anchor">#</a> 禁止cookie盗窃：HttpOnly</h3> <p>在<code>web.config</code>中配置</p> <p>这个配置会告知用户，除了服务器可以修改、设置cookie，其他一切对cookie的操作均无效。</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>httpCookies</span> <span class="token attr-name">domain</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span> <span class="token attr-name">httpOnlyCookies</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>treu<span class="token punctuation">&quot;</span></span> <span class="token attr-name">requireSSL</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre></div><h2 id="威胁-过多提交-over-posting"><a href="#威胁-过多提交-over-posting" class="header-anchor">#</a> 威胁：过多提交（Over-Posting）</h2> <p>在提交表单的时候，我们经常会隐藏一些字段不显示出来，让用户不填写，然后提交</p> <p>但是如果有人恶意提交，例如下面的例子：我们这时候就需要<code>[Bind]</code>属性</p> <div class="language-CSharp extra-class"><pre class="language-csharp"><code><span class="token comment">//model</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Review</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> ReviewId<span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> ProductId<span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Product</span> Product<span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name<span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Comment<span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> Approved<span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>前端，我们只需要让用户填写<code>Name</code>和<code>Comment</code>两个字段值，于是我们前端只渲染两个</p> <div class="language-html extra-class"><pre class="language-html"><code>Name:@Html.TextBox(&quot;Name&quot;) <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
Comment:@Html.TextBox(&quot;Comment&quot;)
</code></pre></div><p>这时候，正常用户可以按需要填写，但是如果是恶意用户，他可以提交<code>Approved=true</code>这种值，因为后端没有进行处理，或者他可以添加一个<code>Product.Price</code>属性，该变商品的价格</p> <p>这时候就需要<code>[Bind]</code>出场了，它可以对我们想要的属性，进行验证、限制，有三种方式：</p> <h3 id="模型类中限制绑定"><a href="#模型类中限制绑定" class="header-anchor">#</a> 模型类中限制绑定</h3> <p>在模型类中，我们可以进行限制，指定我们需要的字段进行绑定，后端接收的时候，就只接收指定字段值</p> <div class="language-CSharp extra-class"><pre class="language-csharp"><code><span class="token comment">//model</span>
<span class="token punctuation">[</span><span class="token function">Bind</span><span class="token punctuation">(</span>Include<span class="token operator">=</span><span class="token string">&quot;Name&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Comment&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Review</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> ReviewId<span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> ProductId<span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Product</span> Product<span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name<span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Comment<span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> Approved<span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="表单提交时绑定"><a href="#表单提交时绑定" class="header-anchor">#</a> 表单提交时绑定</h3> <div class="language-CSharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name">ActionResult</span> <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Bind</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Include<span class="token operator">=</span><span class="token string">&quot;Name&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Comment&quot;</span> <span class="token class-name">Review</span> review<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>或者这种绑定方式</p> <div class="language-CSharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name">ActionResult</span> <span class="token function">Comment</span><span class="token punctuation">(</span><span class="token class-name">Review</span> review<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">UpdateModel</span><span class="token punctuation">(</span>review<span class="token punctuation">,</span><span class="token string">&quot;Review&quot;</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{</span><span class="token string">&quot;Name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Comment&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="直接指定视图模型"><a href="#直接指定视图模型" class="header-anchor">#</a> 直接指定视图模型</h3> <p>这种方式最简单，也方便修改，我们无需显示绑定，在视图中，我们创建一个<code>ReviewModel</code>模型，这样提交的时候，只需要两个字段即可，而且不需要验证，其他字段是无效的</p> <div class="language-CSharp extra-class"><pre class="language-csharp"><code><span class="token comment">//reviewModel</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReviewModel</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name<span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Comment<span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span><span class="token keyword">set</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="威胁-开放重定向攻击"><a href="#威胁-开放重定向攻击" class="header-anchor">#</a> 威胁：开放重定向攻击</h2> <p>开发重定向攻击，简单的描述就是：当我们访问一个页面的时候，若这时我们还未登录，会跳到登陆页，但是会在链接上添加一个<code>ReturnUrl</code>参数用于表示，当我们登录后，继续可以访问登录前，我们需要访问的页面</p> <p>例如：我要访问<code>StoreManager</code>页面的时候，我事先未登录，这时候会要求我先登录。</p> <p><img src="https://i.imgur.com/INvHyYt.png" alt=""></p> <p>当我登录成功，网站会引导我直接跳到<code>StoreManager</code>页面</p> <p><img src="https://i.imgur.com/aI9gucF.png" alt=""></p> <p>这时候，黑客就可以对<code>ReturnUrl</code>下手了，步骤如下：</p> <blockquote><ol><li>如果他将页面重定向到一个十分类似的网站，并且提示用户，密码错误，重试。</li> <li>这时候不是很谨慎的用户，就会重新输入一次</li> <li>当用户再次输入后，恶意网站重定向又会将用户定向到正常页面，由于之前已经通过登录验证，这次用户可以直接浏览首页</li> <li>用户在不之情的情况下，被盗取了账号密码等信息</li></ol></blockquote> <p>我们在开发的时候，怎么避免这种情况的发生呢？</p> <p>后端验证重定向的时候，我们可以验证一下，当前重定向<code>URL</code>是否是本地的地址，这样就可以避免这个问题了，示例：</p> <div class="language-CSharp extra-class"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpPost</span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">AllowAnonymous</span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ValidateAntiForgeryToken</span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>ActionResult<span class="token punctuation">&gt;</span></span> <span class="token function">Login</span><span class="token punctuation">(</span><span class="token class-name">LoginViewModel</span> model<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> returnUrl<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ModelState<span class="token punctuation">.</span>IsValid<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">View</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 这不会计入到为执行帐户锁定而统计的登录失败次数中</span>
    <span class="token comment">// 若要在多次输入错误密码的情况下触发帐户锁定，请更改为 shouldLockout: true</span>
    <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> SignInManager<span class="token punctuation">.</span><span class="token function">PasswordSignInAsync</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>Email<span class="token punctuation">,</span> model<span class="token punctuation">.</span>Password<span class="token punctuation">,</span> model<span class="token punctuation">.</span>RememberMe<span class="token punctuation">,</span> <span class="token named-parameter punctuation">shouldLockout</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">case</span> SignInStatus<span class="token punctuation">.</span>Success<span class="token punctuation">:</span>
            <span class="token comment">//重定向到之前访问页，我们可以写一个方法判断一下</span>
            <span class="token keyword">return</span> <span class="token function">RedirectToLocal</span><span class="token punctuation">(</span>returnUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> SignInStatus<span class="token punctuation">.</span>LockedOut<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token function">View</span><span class="token punctuation">(</span><span class="token string">&quot;Lockout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> SignInStatus<span class="token punctuation">.</span>RequiresVerification<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token function">RedirectToAction</span><span class="token punctuation">(</span><span class="token string">&quot;SendCode&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token punctuation">{</span> ReturnUrl <span class="token operator">=</span> returnUrl<span class="token punctuation">,</span> RememberMe <span class="token operator">=</span> model<span class="token punctuation">.</span>RememberMe <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> SignInStatus<span class="token punctuation">.</span>Failure<span class="token punctuation">:</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>
            ModelState<span class="token punctuation">.</span><span class="token function">AddModelError</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;无效的登录尝试。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">View</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//重定向判断</span>
<span class="token keyword">private</span> <span class="token return-type class-name">ActionResult</span> <span class="token function">RedirectToLocal</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> returnUrl<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">//使用这个方法，判断Url是否是本地的url，若是，则继续跳转</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Url<span class="token punctuation">.</span><span class="token function">IsLocalUrl</span><span class="token punctuation">(</span>returnUrl<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">Redirect</span><span class="token punctuation">(</span>returnUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//否则就跳转到首页，避免了跳转其他页面</span>
    <span class="token keyword">return</span> <span class="token function">RedirectToAction</span><span class="token punctuation">(</span><span class="token string">&quot;Index&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Home&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//或者我们可以提示用户，当用户要跳转至站外站点时</span>
    <span class="token comment">//需要安装包，Elmah;</span>
    <span class="token comment">//这个包可以将异常登录记录下来</span>
    <span class="token class-name"><span class="token keyword">string</span></span> message <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">&quot;Open redirect to to {0} detected.&quot;</span><span class="token punctuation">,</span> returnUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ErrorSignal<span class="token punctuation">.</span><span class="token function">FromCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Raise</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token constructor-invocation class-name">System<span class="token punctuation">.</span>Security<span class="token punctuation">.</span>SecurityException</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">RedirectToAction</span><span class="token punctuation">(</span><span class="token string">&quot;SecurityWarning&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Home&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="使用错误日志、堆栈跟踪程序出错信息"><a href="#使用错误日志、堆栈跟踪程序出错信息" class="header-anchor">#</a> 使用错误日志、堆栈跟踪程序出错信息</h2> <p><code>web.config</code>中有个特性</p> <div class="language-xml extra-class"><pre class="language-xml"><code>&lt;customErrors mode=&quot;off&quot;
</code></pre></div><p>它有三个可选项：</p> <p><code>On</code>：服务器开发的最安全选项，因为它总是隐藏错误提示消息</p> <p><code>RemoteOnly</code>：向大多数用户展示一般的错误提示消息，但是向拥有服务器访问权限的用户展示完整的错误提示信息</p> <p><code>Off</code>：最容易受到攻击的选项，它向访问网站的每个用户展示详细的错误提示消息，如果黑客恶意攻击，可能会导致代码泄露、被关闭程序等。</p> <p>我们可以根据所需来判断是否使用哪种方式，例如发布后，则将之设为<code>On</code>或<code>Remote</code>，调试，则将之设为Off</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>customErrors</span> <span class="token attr-name">mode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Off<span class="token punctuation">&quot;</span></span> <span class="token attr-name">defaultRedirect</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>GenericError.htm<span class="token punctuation">&quot;</span></span> <span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>error</span> <span class="token attr-name">statusCode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>500<span class="token punctuation">&quot;</span></span> <span class="token attr-name">redirect</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>InternalError.htm<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>customErrors</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>参考安全相关的资料</p> <p>推荐：<a href="https://www.troyhunt.com/owasp-top-10-for-net-developers-part-1/" target="_blank" rel="noopener noreferrer">免费资料：其中概括了十种攻击方式，英文资料<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>书籍：《ASP.NET安全编程入门经典》</p> <p><code>AntiXSS</code>：http://antixss.codeplex.com/</p> <p>开放式web应用程序安全项目（OWASP）http://www.owasp.org/</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/WuHaaaaa/WuHaaaaa.github.io/edit/master/docs/backend/dot-net-mvc5/04asp-dot-net-mvc5.md" target="_blank" rel="noopener noreferrer">编辑文档</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2021年1月13日星期三晚上10点29分</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/docs/backend/dot-net-mvc5/03asp-dot-net-mvc5.html" class="prev">
        数据注解，验证
      </a></span> <span class="next"><a href="/docs/backend/dot-net-mvc5/05asp-dot-net-mvc5.html">
        Ajax，jQuery插件用法
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/docs/assets/js/app.ebbf42bd.js" defer></script><script src="/docs/assets/js/2.e91ea41e.js" defer></script><script src="/docs/assets/js/19.afb702b1.js" defer></script><script src="/docs/assets/js/3.f31d052a.js" defer></script>
  </body>
</html>
